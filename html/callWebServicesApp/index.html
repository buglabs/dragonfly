<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">

<html>
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
	<title>Call a Web Service in an Application</title>
	<LINK REL="STYLESHEET" HREF="../../book.css" CHARSET="ISO-8859-1" TYPE="text/css">
</head>

<body bgcolor="#ffffff">
<h1>Call a Web Service in an Application</h1>
<p>

Create a basic application for BUG using a Web service that displays a message on the system output console.

<h2>Create the project</h2>
<ol>
<li>If necessary, switch perspective to the Dragonfly perspective.</li>
<li>In the toolbar, select the 'Launch Virtual BUG' icon <img src="../images/virtual_bug.gif" />.</li>
<li>In the toolbar, select the 'New BUG Project' icon <img src="../images/bugProject.gif" />.</li>
<li>In the Name field of the New BUG Project window, type: LCD Helloworld and select Next.</li>
<li>In the Required Services list mark the checkbox next to IStatusBarProvider, then click Finish.</li>
<li>In the Project Explorer view, expand the <code>lcd_helloworld.servicetracker</code> node.</li>
<li>Double-click to edit the LCD_HelloworldServiceTracker.java file.</li>
<li>Find the doStart() method. This method gets called by Concierge when all our requested services are available. In this instance, we can expect<code> IStatusBarProvider</code> to be available.</li>
<li>In doStart() add the code in Snippet A below.</li>
<li>In doStop() add the code in Snippet B.</li>
<li>Add the fields in Snippet C after <code>public class LCD_HelloworldServiceTracker extends AbstractServiceTracker {</code> </li>
<li>At the very top, with the other import statements, add Snippet D.
</ol>
</p>

<p>
<h2>LCD Helloworld code snippets</h2>
<h3>Snippet A</h3>

<pre class="exampletext">
<em class=examplecode>
<code>
statusBar = (IStatusBarProvider) this.getService(IStatusBarProvider.class);
key = statusBar.acquireRegion("Hello".length());

if (key != null) {
    statusBar.write(key, "Hello");
}

</code>
</em>
</pre>
</p>
<p>

<h3>Snippet B</h3>
<pre class="exampletext">
<em class=examplecode>
<code>
if (key != null) {
    statusBar.releaseRegion(key);
}
</code>
</em>
</pre>
</p>
<p>

<h3>Snippet C</h3>
<pre class="exampletext">
<em class=examplecode>
<code>

private IStatusBarProvider statusBar;
private String key;

</code>
</em>
</pre>
<p>

<h3>Snippet D</h3>
<pre class="exampletext">
<em class=examplecode>

<code>import com.buglabs.status.*;</code>
</em>
</pre>
</p>
<h3>Example after adding Snippets</h3>
<pre class="exampletext">
<em class=examplecode>
<code>
/**
 *	Generated by Dragonfly SDK
 *
 */
package lcd_helloworld.servicetracker;

import org.osgi.framework.BundleContext;
import com.buglabs.application.AbstractServiceTracker;
import com.buglabs.status.*;

 /**
 *	Service tracker for the BugApp Bundle;
 *
 */
public class LCD_HelloworldServiceTracker extends AbstractServiceTracker {	

	private IStatusBarProvider statusBar; 
	private String key;
	
	public LCD_HelloworldServiceTracker(BundleContext context) {
		super(context);
	}
	
	/**
	 * Determines if the application can start.
	 */
	public boolean canStart() {
		return super.canStart();
	}
	
	/**
	 * If canStart returns true
     * this method is called to start the application.
     * Place your fun logic here. 
	 */
	public void doStart() {
		System.out.println("LCD_HelloworldServiceTracker: start");
		statusBar = (IStatusBarProvider) this.getService(IStatusBarProvider.class);
			key = statusBar.acquireRegion("Hello".length());
			if (key != null) { 
				statusBar.write(key, "Hello");
			} 
	}

	/**
	 * Called when a service that this application depends is unregistered.
	 */
	public void doStop() {
		System.out.println("LCD_HelloworldServiceTracker: stop");
		if (key != null) { statusBar.releaseRegion(key);
		} 
	}

	/**
	 * Allows the user to set the service dependencies by
     * adding them to services list returned by getServices().
     * i.e.nl getServices().add(MyService.class.getName());
	 */
	public void initServices() {
		getServices().add("com.buglabs.status.IStatusBarProvider");
	}
	
}
</code>
</em>
</pre>
</p>

<p>

<h2>Run it!</h2>

Stop the Virtual BUG by pressing Esc when the Virtual BUG is selected, and restart the Virtual BUG. You should see the global greeting on the LCD screen.


</p>

<p>

<h2>Concepts</h2>
<ol>
<li>We use an OSGi utility class called the ServiceTracker so that our code runs if and when the services we need are available. When the Activator creates the service, it tells the OSGi runtime which services we are interested in. This information is actually contained in the ServiceTracker implementation (initServices()).</li>
<li>The Status Bar is a shared resource, so we must interact with it in such a way that we do not overwhelm other programs. The <code>IStatusBar.aquireRegion</code> method is the way in which we do this. The <code>IStatusBar</code> implementation manages its resources and will give us what we ask for if it is available. Be sure to release the region when your application stops so that it is free for use by other bundles.</li>
</ol>

</p>



</body>
</html>